/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 ğŸ“  MACRO: ESCRIBA 24/7 â€“ Pergaminos de RECALL
 ğŸ“…  VersiÃ³n 5.4 Â· 24-May-2025
 âœï¸  Autor   : Voorhees
 ğŸ—ºï¸  Servidor: Ãšltima Alianza   Â·   ğŸ’» Cliente: ClassicUO Web

 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸ“–  RESUMEN DETALLADO  ğŸ“– â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 âŠ **Inicio interactivo**  
    â€¢ 5 cursores para seÃ±alar, en orden:  
      1) Cofre de **plumas y tinta** âœ’ï¸  
      2) Cofre de **reagentes** ğŸ§ª  
      3) Cofre de **pergaminos en blanco** ğŸ“„  
      4) Cofre de **salida** (scrolls terminados) ğŸ“¦  
      5) **Comida** ğŸ— (se consumirÃ¡ cada 5 min)  

 â‹ **Restock inteligente**  
    â€¢ Mueve lotes pequeÃ±os â†’ 2 plumas, 40 blanks (hue 0) y 60 unidades  
      de cada reagente requerido.  
    â€¢ Busca recursivamente dentro de sub-contenedores (`depth 0`).  

 âŒ **Ciclo automÃ¡tico**  
    â€¢ _Modo CRAFT_ ğŸ”¨: fabrica Â«âœ¨ FABRICAR ÃšLTIMO âœ¨Â» cada 7 s mientras  
      el manÃ¡ â‰¥ 30 %.  
    â€¢ _Modo MED_ ğŸ§˜: cuando el manÃ¡ < 30 % relanza **Meditation** cada 8 s  
      hasta recuperar â‰¥ 95 %, entonces vuelve a CRAFT.  
    â€¢ Al llegar al **90 % de peso** mueve **todos** los scrolls inscritos  
      (graphic 0x1F4C, cualquier hue) al cofre de salida y continÃºa.  
    â€¢ Come la pieza de comida configurada cada 5 min.

 â **Protecciones**  
    â€¢ Solo usa pergaminos en blanco hue 0 (evita â€œlotes marronesâ€).  
    â€¢ Cierra el gump tras pulsar el botÃ³n 508 para no acumular ventanas.  
    â€¢ Mensajes de depuraciÃ³n (hue 66 / 65 / 33) sin spam global.

 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸ“œ  ÃNDICE DE REAGENTS  ğŸ“œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â€¢ Black Pearl      0x0F7A   â€¢ Blood Moss     0x0F7B
  â€¢ Garlic           0x0F84   â€¢ Ginseng        0x0F85
  â€¢ Mandrake Root    0x0F86   â€¢ Nightshade     0x0F88
  â€¢ Sulfurous Ash    0x0F8C   â€¢ Spiderâ€™s Silk  0x0F8D
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/

/*â•â•â•â•â•â•â•â•â•â•â•â• âš™ï¸  CONFIGURACIÃ“N  â•â•â•â•â•â•â•â•â•â•â•â•*/
const CFG = {
  /*â€• grÃ¡ficos clave â€•*/
  penGraphic      : 0x0FBF,   // âœ’ï¸  Pluma + tinta
  blankGraphic    : 0x0E34,   // ğŸ“„  Pergamino en blanco
  blankHue        : 0x0000,   //     Hue 0 = scroll blanco real
  finishedGraphic : 0x1F4C,   // ğŸ“œ  Cualquier scroll inscrito

  /*â€• lotes mÃ­nimos y de reposiciÃ³n â€•*/
  minPens : 1,   grabPens : 2,
  minBlanks : 10, grabBlanks : 40,
  minEachReagent : 30, grabReags : 60,

  /*â€• umbrales y tiempos â€•*/
  weightThresh   : 0.90,      // 90 % del peso mÃ¡x.
  foodEveryMs    : 5 * 60 * 1000,
  manaLow        : 0.30,      // <30 % -> Meditar
  manaFull       : 0.95,      // â‰¥95 % -> volver a CRAFT
  medRetryMs     : 8000,      // reintento Meditation
  craftDelayMs   : 7000,      // enfriamiento entre crafts
  loopDelayMs    : 350,

  /*â€• InscripciÃ³n â€•*/
  inscriptGump   : 0x460,
  craftLastBtn   : 508
};

/*â•â•â•â•â•â•â•â•â•â•â•â• ğŸƒ  RECIPE â€“ RECALL  ğŸƒ â•â•â•â•â•â•â•â•â•â•â•â•*/
const RECIPE = [0x0F7A, 0x0F7B, 0x0F86];

/*â•â•â•â•â•â•â•â•â•â•â•â• ğŸ› ï¸  UTILIDADES  ğŸ› ï¸ â•â•â•â•â•â•â•â•â•â•â•â•â•*/
const say = (txt:string, hue=66)=>client.sysMsg(txt,hue);

/*â”€â”€ 1. CAPTURA DE TARGETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const BOX = { pen:0, reag:0, blank:0, out:0, foodG:0 };
function ask<K extends keyof typeof BOX>(k:K, label:string, useGraphic=false){
  say(`ğŸ“Œ ${label} â€“ haz clic`,34);
  const t=target.query(); if(!t) exit(`Cancelado`);
  BOX[k]=useGraphic?t.graphic:t.serial; say(`${label} OK`,88);
}
ask('pen','Cont. PLUMAS'); ask('reag','Cont. REAGENTES');
ask('blank','Cont. BLANKS'); ask('out','Cont. SALIDA');
ask('foodG','COMIDA',true);

/*â”€â”€ 2. INVENTARIO Y MOVIMIENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const qty = (gfx:number, hue:number|null=null)=>
 (client.findAllItemsOfType(gfx,hue??undefined,player.backpack,undefined,0) as Item[]|[])
 .reduce((n,i)=>n+i.amount,0);

const move = (it:Item, amount:number, dst:number)=>{
  player.moveItem(it.serial, dst, 0,0,0, amount);
  sleep(300);
};

/*â”€â”€ 3. RESTOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function fetch(box:number,gfx:number,hue:number|null,min:number,take:number){
  let need=min-qty(gfx,hue); if(need<=0)return;
  const stacks=client.findAllItemsOfType(gfx,hue??undefined,box,undefined,0) as Item[];
  for(const s of stacks){
    const part=Math.min(take,s.amount,need);
    move(s,part,player.backpack); need-=part; if(need<=0)break;
  }
}
function restock(){
  fetch(BOX.pen,   CFG.penGraphic,   null,           CFG.minPens,        CFG.grabPens  );
  fetch(BOX.blank, CFG.blankGraphic, CFG.blankHue,   CFG.minBlanks,      CFG.grabBlanks);
  for(const g of RECIPE)
    fetch(BOX.reag, g,              null,           CFG.minEachReagent, CFG.grabReags);
}

/*â”€â”€ 4. DESCARGA FIABLE DE SCROLLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function dumpScrolls(){
  const list=client.findAllItemsOfType(
               CFG.finishedGraphic,undefined,player.backpack,undefined,0) as Item[];
  for(const s of list) move(s,s.amount,BOX.out);
}

/*â”€â”€ 5. COMIDA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let nextMeal=Date.now()+CFG.foodEveryMs;
function feedIfNeeded(){
  if(Date.now()<nextMeal) return;
  const food=client.findType(BOX.foodG,undefined,player.backpack) as Item;
  if(food) player.use(food);
  nextMeal=Date.now()+CFG.foodEveryMs;
}

/*â”€â”€ 6. MANÃ & ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
type Mode='CRAFT'|'MED'; let mode:Mode='CRAFT';
let nextMedTry=0, nextCraft=0;
const manaRatio=()=>player.mana/player.maxMana;
function medLoop(){
  if(Date.now()<nextMedTry) return;
  try{player.useSkill('Meditation');}catch{player.useSkill(46);}
  nextMedTry=Date.now()+CFG.medRetryMs;
}

/*â”€â”€ 7. CRAFTEO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const haveRegs=()=>RECIPE.every(g=>qty(g)>=CFG.minEachReagent);
function craftOne(){
  if(Date.now()<nextCraft) return;
  if(!haveRegs()){ restock(); return; }

  const pen  = client.findType(CFG.penGraphic,undefined,player.backpack) as Item;
  const blank= client.findType(CFG.blankGraphic,CFG.blankHue,player.backpack) as Item;
  if(!pen||!blank){ restock(); return; }

  player.use(pen); player.use(blank);
  const g=Gump.findOrWait(CFG.inscriptGump,800);
  if(g&&g.hasButton(CFG.craftLastBtn)){ g.reply(CFG.craftLastBtn); g.close(); }
  else say('âš ï¸ BotÃ³n no hallado',33);

  nextCraft=Date.now()+CFG.craftDelayMs;
}

/*â•â•â•â•â•â•â•â•â•â•â•â• ğŸš€  LOOP PRINCIPAL  â•â•â•â•â•â•â•â•â•â•â•â•â•*/
say('âœ… Macro ON â€“ Â¡a escribir!',65);
while(true){
  feedIfNeeded();
  restock();

  const m=manaRatio();
  if(mode==='CRAFT' && m<CFG.manaLow ){ mode='MED'; nextMedTry=0; say('ğŸ§˜ Meditarâ€¦',66);}
  if(mode==='MED'   && m>=CFG.manaFull){ mode='CRAFT'; say('ğŸ”¨ Retoma crafteo',65);}

  if(mode==='MED') medLoop();
  else{
    if(player.weight/player.weightMax >= CFG.weightThresh){
      say('ğŸ“¦ Peso alto â€“ descargando scrollsâ€¦',66); dumpScrolls();
    }
    craftOne();
  }
  sleep(CFG.loopDelayMs);
}
